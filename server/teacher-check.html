<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•™å¸ˆèµ„æ ¼è¯æ ¸æŸ¥</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 20px;
            margin-bottom: 15px;
            color: #eee;
        }

        .status-bar {
            background: #16213e;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.ready { background: #4ade80; }
        .status-dot.scanning { background: #facc15; animation: pulse 1s infinite; }
        .status-dot.success { background: #4ade80; }
        .status-dot.error { background: #ef4444; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .camera-box {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            display: none;
        }

        .guide-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 60%;
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 8px;
            pointer-events: none;
        }

        .guide-text {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            text-align: center;
            background: rgba(0,0,0,0.5);
            padding: 5px 12px;
            border-radius: 15px;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4f46e5;
            color: #fff;
        }

        .btn-primary:hover { background: #4338ca; }
        .btn-primary:disabled { background: #666; cursor: not-allowed; }

        .btn-secondary {
            background: #374151;
            color: #fff;
        }

        .btn-secondary:hover { background: #4b5563; }

        .upload-btn {
            display: none;
        }

        .result-box {
            background: #16213e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 10px;
        }

        .result-content {
            font-size: 16px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #374151;
        }

        .result-item:last-child { border-bottom: none; }

        .result-label { color: #9ca3af; }
        .result-value { font-weight: 600; }

        .match-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }

        .match-found {
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid #4ade80;
            color: #4ade80;
        }

        .match-not-found {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .ocr-text {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .upload-area {
            background: #16213e;
            border: 2px dashed #374151;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #4f46e5;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 14px;
            color: #9ca3af;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ•™å¸ˆèµ„æ ¼è¯æ ¸æŸ¥ç³»ç»Ÿ</h1>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">å‡†å¤‡å°±ç»ª</span>
        </div>

        <!-- ä¸Šä¼ ExcelåŒºåŸŸ -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('excelInput').click()">
            <div class="upload-icon">ğŸ“Š</div>
            <div class="upload-text">ç‚¹å‡»ä¸Šä¼  Excel æ–‡ä»¶</div>
        </div>
        <input type="file" id="excelInput" accept=".xlsx,.xls" class="upload-btn">

        <!-- æ‘„åƒå¤´åŒºåŸŸ -->
        <div class="camera-box" id="cameraBox">
            <video id="video" autoplay playsinline></video>
            <div class="guide-frame"></div>
            <div class="guide-text">å°†æ•™å¸ˆèµ„æ ¼è¯æ”¾å…¥æ¡†å†…ï¼Œä¿æŒç¨³å®š</div>
        </div>
        <canvas id="canvas"></canvas>

        <!-- æŒ‰é’®åŒºåŸŸ -->
        <div class="btn-row">
            <button class="btn btn-secondary" id="uploadPhotoBtn" onclick="document.getElementById('photoInput').click()">
                ğŸ“· ä»ç›¸å†Œé€‰æ‹©
            </button>
            <button class="btn btn-primary" id="captureBtn" onclick="manualCapture()">
                ğŸ” ç«‹å³è¯†åˆ«
            </button>
        </div>
        <input type="file" id="photoInput" accept="image/*" class="upload-btn">

        <!-- è¯†åˆ«ç»“æœ -->
        <div class="result-box hidden" id="resultBox">
            <div class="result-title">è¯†åˆ«ç»“æœ</div>
            <div class="result-content" id="resultContent"></div>
            <div class="ocr-text" id="ocrText"></div>
        </div>
    </div>

    <script>
        // é…ç½® - APIåœ°å€ï¼ˆRenderéƒ¨ç½²æ—¶ä¿æŒç›¸å¯¹è·¯å¾„ï¼‰
        const API_PROXY = '/api/ocr';

        // çŠ¶æ€å˜é‡
        let excelData = [];
        let videoStream = null;
        let lastFrameData = null;
        let stabilityTimer = null;
        let isProcessing = false;

        // å…ƒç´ 
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const resultBox = document.getElementById('resultBox');
        const resultContent = document.getElementById('resultContent');
        const ocrText = document.getElementById('ocrText');

        // åˆå§‹åŒ–
        async function init() {
            try {
                // å¯åŠ¨æ‘„åƒå¤´
                await startCamera();
                // ä¸Šä¼ Excelç›‘å¬
                document.getElementById('excelInput').addEventListener('change', handleExcelUpload);
                document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
                updateStatus('ready', 'å‡†å¤‡å°±ç»ª');
            } catch (error) {
                updateStatus('error', 'åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: false
                });
                video.srcObject = videoStream;
                updateStatus('ready', 'æ‘„åƒå¤´å·²å¯åŠ¨');

                // å¼€å§‹ç¨³å®šæ£€æµ‹
                startStabilityCheck();
            } catch (error) {
                updateStatus('error', 'æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message);
            }
        }

        // ç¨³å®šæ£€æµ‹
        function startStabilityCheck() {
            const ctx = canvas.getContext('2d');

            function checkStability() {
                if (isProcessing) {
                    stabilityTimer = requestAnimationFrame(checkStability);
                    return;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const currentData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const diff = compareFrames(lastFrameData, currentData);

                if (diff < 0.02 && lastFrameData !== null) {
                    // ç”»é¢ç¨³å®šï¼Œå¼€å§‹å€’è®¡æ—¶
                    if (!stabilityTimer) {
                        updateStatus('scanning', 'ç”»é¢ç¨³å®šï¼Œ3ç§’åè‡ªåŠ¨æ‹ç…§...');
                        let countdown = 3;

                        stabilityTimer = setInterval(() => {
                            countdown--;
                            if (countdown <= 0) {
                                clearInterval(stabilityTimer);
                                stabilityTimer = null;
                                captureAndRecognize();
                            } else {
                                updateStatus('scanning', `ç”»é¢ç¨³å®šï¼Œ${countdown}ç§’åè‡ªåŠ¨æ‹ç…§...`);
                            }
                        }, 1000);
                    }
                } else {
                    // ç”»é¢ä¸ç¨³å®š
                    if (stabilityTimer) {
                        clearInterval(stabilityTimer);
                        stabilityTimer = null;
                    }
                    if (lastFrameData !== null) {
                        updateStatus('ready', 'å°†è¯ä¹¦æ”¾ç¨³åè‡ªåŠ¨è¯†åˆ«');
                    }
                }

                lastFrameData = currentData;
                stabilityTimer = requestAnimationFrame(checkStability);
            }

            checkStability();
        }

        // æ¯”è¾ƒä¸¤å¸§å·®å¼‚
        function compareFrames(frame1, frame2) {
            if (!frame1 || !frame2) return 1;
            if (frame1.data.length !== frame2.data.length) return 1;

            let diff = 0;
            const data1 = frame1.data;
            const data2 = frame2.data;
            const step = 4; // é‡‡æ ·æ­¥é•¿

            for (let i = 0; i < data1.length; i += step) {
                diff += Math.abs(data1[i] - data2[i]);
            }

            return diff / (data1.length / 4) / 255;
        }

        // æ‰‹åŠ¨æ‹ç…§
        function manualCapture() {
            if (isProcessing) return;
            if (stabilityTimer) {
                clearInterval(stabilityTimer);
                stabilityTimer = null;
            }
            captureAndRecognize();
        }

        // æ‹ç…§å¹¶è¯†åˆ«
        async function captureAndRecognize() {
            isProcessing = true;
            updateStatus('scanning', 'æ­£åœ¨è¯†åˆ«...');

            // æ‹ç…§
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            const imageBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            try {
                // è°ƒç”¨ç™¾åº¦OCR
                const ocrResult = await callOCR(imageBase64);

                // æå–ä¿¡æ¯
                const extracted = extractInfo(ocrResult);

                // åŒ¹é…æ•°æ®
                const matchResult = matchData(extracted);

                // æ˜¾ç¤ºç»“æœ
                showResult(extracted, matchResult);
                updateStatus('success', 'è¯†åˆ«å®Œæˆ');
            } catch (error) {
                updateStatus('error', 'è¯†åˆ«å¤±è´¥: ' + error.message);
            }

            isProcessing = false;
        }

        // è°ƒç”¨OCR API (é€šè¿‡Vercelä»£ç†)
        async function callOCR(imageBase64) {
            const response = await fetch(API_PROXY, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageBase64 })
            });

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error || 'OCRè¯†åˆ«å¤±è´¥');
            }

            return data;
        }

        // æå–å…³é”®ä¿¡æ¯
        function extractInfo(ocrResult) {
            const allText = ocrResult.words_result ?
                ocrResult.words_result.map(r => r.words).join('\n') :
                ocrResult.words_result_alt || '';

            const result = {
                rawText: allText,
                idNumber: '',
                qualificationType: '',
                subject: ''
            };

            // æå–èº«ä»½è¯å· (18ä½)
            // æå–èº«ä»½è¯å· (18ä½æˆ–15ä½)
            const idMatch = allText.match(/\d{17}[\dXx]|\d{15}/);
            if (idMatch) result.idNumber = idMatch[0];

            // æå–èµ„æ ¼ç§ç±»
            const qualificationKeywords = ['é«˜çº§ä¸­å­¦', 'ä¸­ç­‰èŒä¸šå­¦æ ¡', 'åˆçº§ä¸­å­¦', 'å°å­¦', 'å¹¼å„¿å›­', 'ç‰¹æ®Šæ•™è‚²'];
            for (const kw of qualificationKeywords) {
                if (allText.includes(kw)) {
                    result.qualificationType = kw;
                    break;
                }
            }

            // æå–ä»»æ•™å­¦ç§‘ - å¸¸è§çš„å­¦ç§‘å…³é”®è¯
            const subjectKeywords = [
                'è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©',
                'æ”¿æ²»', 'å†å²', 'åœ°ç†', 'éŸ³ä¹', 'ç¾æœ¯', 'ä½“è‚²',
                'ä¿¡æ¯æŠ€æœ¯', 'é€šç”¨æŠ€æœ¯', 'ç§‘å­¦', 'å¿ƒç†å¥åº·', 'å­¦å‰æ•™è‚²'
            ];
            for (const kw of subjectKeywords) {
                if (allText.includes(kw)) {
                    result.subject = kw;
                    break;
                }
            }

            return result;
        }

        // åŒ¹é…Excelæ•°æ®
        function matchData(extracted) {
            if (!extracted.idNumber) {
                return { found: false, reason: 'æœªè¯†åˆ«åˆ°èº«ä»½è¯å·' };
            }

            if (excelData.length === 0) {
                return { found: false, reason: 'è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶' };
            }

            // æŸ¥æ‰¾åŒ¹é…
            const match = excelData.find(row => {
                const excelId = String(row['è¯ä»¶å·ç '] || '').trim();
                return excelId === extracted.idNumber;
            });

            if (!match) {
                return { found: false, reason: 'è¯¥èº«ä»½è¯å·ä¸åœ¨åº“ä¸­' };
            }

            // å¦‚æœè¯†åˆ«åˆ°äº†èµ„æ ¼ç§ç±»æˆ–å­¦ç§‘ï¼ŒéªŒè¯æ˜¯å¦åŒ¹é…
            if (extracted.qualificationType && match['èµ„æ ¼ç§ç±»'] !== extracted.qualificationType) {
                return {
                    found: false,
                    reason: `èµ„æ ¼ç§ç±»ä¸åŒ¹é…ï¼šExcelä¸º"${match['èµ„æ ¼ç§ç±»']}"ï¼Œè¯†åˆ«ä¸º"${extracted.qualificationType}"`
                };
            }

            if (extracted.subject && match['ä»»æ•™å­¦ç§‘'] !== extracted.subject) {
                return {
                    found: false,
                    reason: `ä»»æ•™å­¦ç§‘ä¸åŒ¹é…ï¼šExcelä¸º"${match['ä»»æ•™å­¦ç§‘']}"ï¼Œè¯†åˆ«ä¸º"${extracted.subject}"`
                };
            }

            return {
                found: true,
                data: match
            };
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(extracted, matchResult) {
            resultBox.classList.remove('hidden');

            let html = `
                <div class="result-item">
                    <span class="result-label">èº«ä»½è¯å·</span>
                    <span class="result-value">${extracted.idNumber || 'æœªè¯†åˆ«'}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">èµ„æ ¼ç§ç±»</span>
                    <span class="result-value">${extracted.qualificationType || 'æœªè¯†åˆ«'}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ä»»æ•™å­¦ç§‘</span>
                    <span class="result-value">${extracted.subject || 'æœªè¯†åˆ«'}</span>
                </div>
            `;

            if (matchResult.found) {
                html += `
                    <div class="match-result match-found">
                        âœ… æ ¸æŸ¥é€šè¿‡ï¼š${matchResult.data['ç¡®è®¤ç‚¹']} - ${matchResult.data['ä»»æ•™å­¦ç§‘']}
                    </div>
                `;
            } else {
                html += `
                    <div class="match-result match-not-found">
                        âš ï¸ ${matchResult.reason}
                    </div>
                `;
            }

            resultContent.innerHTML = html;
            ocrText.textContent = extracted.rawText;
        }

        // å¤„ç†Excelä¸Šä¼ 
        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    excelData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                    updateStatus('ready', `å·²åŠ è½½ ${excelData.length} æ¡æ•°æ®`);
                    document.getElementById('uploadArea').classList.add('hidden');
                } catch (error) {
                    updateStatus('error', 'Excelè§£æå¤±è´¥: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å¤„ç†ç›¸å†Œç…§ç‰‡
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                isProcessing = true;
                updateStatus('scanning', 'æ­£åœ¨è¯†åˆ«...');

                try {
                    const imageBase64 = e.target.result.split(',')[1];
                    const ocrResult = await callOCR(imageBase64);
                    const extracted = extractInfo(ocrResult);
                    const matchResult = matchData(extracted);
                    showResult(extracted, matchResult);
                    updateStatus('success', 'è¯†åˆ«å®Œæˆ');
                } catch (error) {
                    updateStatus('error', 'è¯†åˆ«å¤±è´¥: ' + error.message);
                }

                isProcessing = false;
            };
            reader.readAsDataURL(file);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        // å¯åŠ¨
        init();
    </script>
</body>
</html>
