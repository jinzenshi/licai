<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>教师资格证核查</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
        }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        h1 { text-align: center; font-size: 18px; margin-bottom: 10px; color: #eee; }
        .status-bar {
            background: #16213e; border-radius: 8px; padding: 10px 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px; font-size: 13px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; }
        .status-dot.ready { background: #4ade80; }
        .status-dot.scanning { background: #facc15; animation: pulse 0.3s infinite; }
        .status-dot.success { background: #4ade80; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .camera-box {
            position: relative; width: 100%; aspect-ratio: 4/3; background: #000;
            border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #canvas { display: none; }
        .guide-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 55%; border: 2px dashed rgba(255,255,255,0.4); border-radius: 6px;
        }
        .guide-text {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            font-size: 11px; color: rgba(255,255,255,0.6); background: rgba(0,0,0,0.4);
            padding: 4px 10px; border-radius: 12px;
        }
        .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer;
        }
        .btn-primary { background: #4f46e5; color: #fff; }
        .btn-success { background: #059669; color: #fff; }
        .btn-danger { background: #dc2626; color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .count-info { text-align: center; font-size: 12px; color: #9ca3af; margin-bottom: 10px; }
        .result-box {
            background: #16213e; border-radius: 10px; padding: 12px; margin-top: 10px;
        }
        .result-title { font-size: 12px; color: #9ca3af; margin-bottom: 8px; }
        .stat-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .stat-item {
            flex: 1; padding: 10px; border-radius: 6px; text-align: center;
            font-size: 13px;
        }
        .stat-pass { background: rgba(74, 222, 128, 0.15); border: 1px solid #4ade80; }
        .stat-fail { background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; }
        .stat-num { font-size: 20px; font-weight: 700; display: block; }
        .result-list { max-height: 300px; overflow-y: auto; }
        .result-item {
            padding: 8px; border-bottom: 1px solid #2a3a5e; font-size: 12px;
        }
        .result-item:last-child { border-bottom: none; }
        .result-name { font-weight: 600; color: #fff; }
        .result-id { color: #9ca3af; font-size: 11px; }
        .result-pass { color: #4ade80; }
        .result-fail { color: #ef4444; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>教师资格证核查</h1>
        <div class="status-bar">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">准备就绪</span>
        </div>
        <div class="camera-box">
            <video id="video" autoplay playsinline muted></video>
            <div class="guide-frame"></div>
            <div class="guide-text">将证书放入框内拍照</div>
        </div>
        <canvas id="canvas"></canvas>
        <div class="count-info">已收集: <span id="collected">0</span> | 待返回: <span id="pending">0</span></div>
        <div class="btn-row">
            <button class="btn btn-success" id="startBtn" onclick="startTask()">开始任务</button>
            <button class="btn btn-primary" id="captureBtn" onclick="captureAndQuery()" disabled>拍照并收集</button>
            <button class="btn btn-danger" id="endBtn" onclick="endTask()" disabled>结束任务</button>
        </div>
        <div class="result-box hidden" id="resultBox">
            <div class="result-title">核查结果</div>
            <div class="stat-row">
                <div class="stat-item stat-pass">
                    <span class="stat-num" id="passCount">0</span>通过
                </div>
                <div class="stat-item stat-fail">
                    <span class="stat-num" id="failCount">0</span>未通过
                </div>
            </div>
            <div class="result-list" id="resultList"></div>
        </div>
    </div>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const resultBox = document.getElementById('resultBox');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const endBtn = document.getElementById('endBtn');
        const collectedSpan = document.getElementById('collected');
        const pendingSpan = document.getElementById('pending');
        const passCountSpan = document.getElementById('passCount');
        const failCountSpan = document.getElementById('failCount');
        const resultList = document.getElementById('resultList');

        let taskActive = false;
        let pendingQueries = [];
        let results = [];

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 960 } },
                    audio: false
                });
                video.srcObject = stream;
                updateStatus('ready', '请开始任务');
            } catch (e) {
                updateStatus('error', '无法访问摄像头');
            }
        }

        function updateStatus(status, text) {
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        function startTask() {
            taskActive = true;
            pendingQueries = [];
            results = [];
            startBtn.disabled = true;
            captureBtn.disabled = false;
            endBtn.disabled = false;
            resultBox.classList.add('hidden');
            updateStatus('scanning', '任务进行中...');
        }

        function captureAndQuery() {
            if (!taskActive) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

            // 发送查询请求
            const queryPromise = fetch('/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageBase64 })
            }).then(res => res.json());

            pendingQueries.push(queryPromise);
            updatePendingCount();
        }

        function updatePendingCount() {
            collectedSpan.textContent = results.length;
            pendingSpan.textContent = pendingQueries.length;
        }

        async function endTask() {
            taskActive = false;
            captureBtn.disabled = true;
            endBtn.disabled = true;
            startBtn.disabled = false;
            updateStatus('scanning', '等待返回结果...');

            // 等待所有请求完成
            const allResults = await Promise.all(pendingQueries);

            // 收集结果
            results = allResults.filter(r => r && r.idNumber);

            showResults();
            updatePendingCount();
            updateStatus('success', '任务完成');
        }

        function showResults() {
            resultBox.classList.remove('hidden');

            // 去重：根据身份证号去重，保留第一条记录
            const seen = new Set();
            const uniqueResults = [];
            results.forEach(r => {
                // 如果没有身份证号，也保留（可能是识别失败的情况）
                if (!r.idNumber) {
                    uniqueResults.push(r);
                    return;
                }
                // 有身份证号的去重
                if (!seen.has(r.idNumber)) {
                    seen.add(r.idNumber);
                    uniqueResults.push(r);
                }
            });

            const pass = uniqueResults.filter(r => r.match && r.match.found === true);
            const fail = uniqueResults.filter(r => !r.match || r.match.found !== true);

            passCountSpan.textContent = pass.length;
            failCountSpan.textContent = fail.length;

            let html = '';
            pass.forEach(r => {
                if (r.match && r.match.data) {
                    html += `
                        <div class="result-item">
                            <span class="result-name result-pass">✅ ${r.match.data.姓名}</span>
                            <span class="result-id">${r.idNumber} - ${r.match.data.资格种类} - ${r.match.data.任教学科}</span>
                        </div>
                    `;
                }
            });
            fail.forEach(r => {
                const name = r.match && r.match.name ? r.match.name : '';
                const reason = r.match && r.match.reason ? r.match.reason : '未识别到身份证号';
                let detail = r.idNumber || '未知';
                if (r.qualificationType) detail += ` (识:${r.qualificationType}${r.subject ? '-' + r.subject : ''})`;
                const displayName = name ? `【${name}】` : '';
                html += `
                    <div class="result-item">
                        <span class="result-name result-fail">❌ ${displayName}${reason}</span>
                        <span class="result-id">${detail}</span>
                    </div>
                `;
            });
            resultList.innerHTML = html;
        }

        init();
    </script>
</body>
</html>
